build_steps:
- desc: Install dependencies
  cmd: |
    # OpenJDK
    apt-get update
    apt-get install -y openjdk-8* python3-pip bats
    # Leiningen
    curl https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein >/usr/bin/lein
    chmod a+x /usr/bin/lein
- desc: 'Install Docker'
  cmd: 'curl -sSL https://delivery.cloud.zalando.com/utils/ensure-docker | sh'
- desc: Run unit tests
  cmd: |
    export LEIN_ROOT=1
    docker run -d -p 5432:5432 postgres:9.4
    DB_SUBNAME=//localhost:5432/postgres lein test
- desc: Build and push docker image
  cmd: |
    export LEIN_ROOT=1
    # TODO remove scm-source.json from Dockerfile first
    lein set-version "${CDP_BUILD_VERSION}"
    lein uberjar
    touch target/scm-source.json
    IS_PR_BUILD=${CDP_PULL_REQUEST_NUMBER+"true"}
    if [[ $CDP_TARGET_BRANCH == "master" && ${IS_PR_BUILD} != "true" ]]
    then
      IMAGE_NAME=pierone
    else
      IMAGE_NAME=pierone-test
    fi
    docker build -t pierone.stups.zalan.do/stups/${IMAGE_NAME}:${CDP_BUILD_VERSION} .
    docker push pierone.stups.zalan.do/stups/${IMAGE_NAME}:${CDP_BUILD_VERSION}
    docker tag pierone.stups.zalan.do/stups/${IMAGE_NAME}:${CDP_BUILD_VERSION} registry-write.opensource.zalan.do/stups/${IMAGE_NAME}:${CDP_BUILD_VERSION}
    docker push registry-write.opensource.zalan.do/stups/${IMAGE_NAME}:${CDP_BUILD_VERSION}
